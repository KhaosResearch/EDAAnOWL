name: Deploy Ontology to GitHub Pages

on:
  # Execute on new release creation
  release:
    types: [created]
  # Or manually trigger via "Run workflow" button
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Tag Versions
        id: get_version
        shell: bash
        run: |
          TAG_CON_V=${{ github.ref_name }}
          echo "VERSION_TAG_V=$TAG_CON_V" >> $GITHUB_OUTPUT
          echo "VERSION_NO_V=${TAG_CON_V#v}" >> $GITHUB_OUTPUT

      - name: Set up Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Download Widoco
        run: wget -O widoco.jar https://github.com/dgarijo/Widoco/releases/download/v1.4.25/widoco-1.4.25-jar-with-dependencies_JDK-17.jar

      - name: Generate dynamic catalog.xml
        id: catalog
        shell: bash
        run: |
          TAG_NO_V=${{ steps.get_version.outputs.VERSION_NO_V }} # p.e. 0.0.1
          echo "--- Generating catalog-v0.xml for version $TAG_NO_V ---"

          cat << EOF > catalog-v0.xml
          <?xml version="1.0" encoding="UTF-8"?>
          <catalog xmlns="urn:oasis:names:tc:entity:xmlns:xml:catalog" prefer="public">
            <uri name="https://w3id.org/EDAAnOWL/$TAG_NO_V/"
                 uri="file:./src/$TAG_NO_V/EDAAnOWL.ttl"/>
          EOF

          VOCAB_FILES=$(ls src/$TAG_NO_V/vocabularies/*.ttl 2>/dev/null || true)
          if [ -n "$VOCAB_FILES" ]; then
            for F in $VOCAB_FILES; do
              FILENAME=$(basename "$F")              # agro-vocab.ttl
              BASENAME=${FILENAME%.ttl}              # agro-vocab
              echo "  <!-- Vocab: $BASENAME -->" >> catalog-v0.xml
              echo "  <uri name=\"https://w3id.org/EDAAnOWL/$TAG_NO_V/vocabularies/$BASENAME\"" >> catalog-v0.xml
              echo "       uri=\"file:./$F\"/>" >> catalog-v0.xml
            done
          else
            echo "--- No vocabularies found in src/$TAG_NO_V/vocabularies/ ---"
          fi

          echo "</catalog>" >> catalog-v0.xml
          echo "--- Catalog Created ---"
          cat catalog-v0.xml

      - name: Generate documentation with Widoco
        shell: bash
        run: |
          TAG_NO_V=${{ steps.get_version.outputs.VERSION_NO_V }}
          echo "Generating documentation for version $TAG_NO_V"
          mkdir -p build/docs
          java -Djena.catalog.xml=catalog-v0.xml -jar widoco.jar \
            -ontFile src/$TAG_NO_V/EDAAnOWL.ttl \
            -outFolder build/docs \
            -getOntologyMetadata \
            -webVowl \
            -licensius \
            -rewriteAll

      - name: Post-process Widoco HTML (force versioned vocab links)
        shell: bash
        run: |
          set -euo pipefail
          V="${{ steps.get_version.outputs.VERSION_NO_V }}"
          shopt -s nullglob
          # Rewrite all HTML files generated by Widoco
          for f in build/docs/doc/*.html build/docs/doc/*/*.html; do
            sed -i -E "s|(href=\")https://w3id.org/EDAAnOWL/vocabularies/([A-Za-z0-9._-]+)\"|\\1https://w3id.org/EDAAnOWL/${V}/vocabularies/\\2\"|g" "$f"
          done

      - name: Prepare files for deployment
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          DEST_VERSION=${{ steps.get_version.outputs.VERSION_NO_V }} # p.ej., 0.0.1

          echo "Preparing files for deploy folder $DEST_VERSION"
          mkdir -p deploy/$DEST_VERSION

          echo "Copying WebVowl/HTML documentation files..."
          cp -r build/docs/doc/* deploy/$DEST_VERSION/

          echo "Copying RDF serialization files from Widoco (ontology.*)..."
          find build/docs -maxdepth 1 -type f -exec cp -t deploy/$DEST_VERSION/ {} +

          echo "Ensuring EDAAnOWL.ttl exists alongside ontology.ttl..."
          # Also copy the source TTL named EDAAnOWL.ttl (useful for .htaccess)
          if [ -f "src/$DEST_VERSION/EDAAnOWL.ttl" ]; then
            cp -f "src/$DEST_VERSION/EDAAnOWL.ttl" "deploy/$DEST_VERSION/EDAAnOWL.ttl"
          else
            echo "WARN: src/$DEST_VERSION/EDAAnOWL.ttl not found; only ontology.ttl (Widoco) will be present."
          fi

          echo "Copying vocabularies..."
          mkdir -p deploy/$DEST_VERSION/vocabularies
          VOCAB_FILES=$(ls src/$DEST_VERSION/vocabularies/*.ttl 2>/dev/null || true)
          if [ -n "$VOCAB_FILES" ]; then
            cp src/$DEST_VERSION/vocabularies/*.ttl deploy/$DEST_VERSION/vocabularies/
          else
            echo "--- No vocabularies found in src/$DEST_VERSION/vocabularies/ to copy ---"
          fi

          echo "Copying README.md..."
          if [ -f "src/$DEST_VERSION/README.md" ]; then
            cp "src/$DEST_VERSION/README.md" "deploy/$DEST_VERSION/README.md"
          else
            echo "--- No README.md found in src/$DEST_VERSION/ ---"
          fi

          echo "Syncing 'latest'..."
          rm -rf deploy/latest
          cp -r deploy/$DEST_VERSION deploy/latest

          echo "Disabling Jekyll..."
          touch deploy/.nojekyll

          echo "DEPLOY_ROOT=deploy" >> $GITHUB_OUTPUT

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ steps.prep.outputs.DEPLOY_ROOT }}
          publish_branch: gh-pages
          force_orphan: true
