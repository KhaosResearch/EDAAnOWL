name: Deploy Ontology to GitHub Pages

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Tag Versions
        id: get_version
        shell: bash
        run: |
          TAG_CON_V=${{ github.ref_name }}
          echo "VERSION_TAG_V=$TAG_CON_V" >> $GITHUB_OUTPUT
          echo "VERSION_NO_V=${TAG_CON_V#v}" >> $GITHUB_OUTPUT

      - name: Set up Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Download Widoco
        run: wget -O widoco.jar https://github.com/dgarijo/Widoco/releases/download/v1.4.25/widoco-1.4.25-jar-with-dependencies_JDK-17.jar

      - name: Generate documentation with Widoco
        shell: bash
        run: |
          TAG_NO_V=${{ steps.get_version.outputs.VERSION_NO_V }}
          echo "Generating documentation for version $TAG_NO_V"

          VOCAB_IMPORTS=""
          VOCAB_FILES=$(ls src/$TAG_NO_V/vocabularies/*.ttl 2>/dev/null || true)
          if [ -n "$VOCAB_FILES" ]; then
            for F in $VOCAB_FILES; do
              VOCAB_IMPORTS="$VOCAB_IMPORTS -import ./vocabularies/$(basename $F)"
            done
            echo "Found vocabs: $VOCAB_IMPORTS"
          else
            echo "--- No vocabularies found in src/$TAG_NO_V/vocabularies/ ---"
          fi

          echo "--- Running Widoco ---"
          java -jar ../../widoco.jar \
            -ontFile EDAAnOWL.ttl \
            -outFolder /home/runner/work/EDAAnOWL/EDAAnOWL/build/docs \
            -oops \
            -lang en-es \
            -webVowl \
            -rewriteAll \
            -htaccess \
            -uniteSections \
            -includeAnnotationProperties \
            $VOCAB_IMPORTS
        working-directory: ./src/${{ steps.get_version.outputs.VERSION_NO_V }}

      - name: Post-process Widoco HTML
        shell: bash
        run: |
          set -euo pipefail
          V="${{ steps.get_version.outputs.VERSION_NO_V }}"
          shopt -s nullglob
          for f in build/docs/doc/*.html build/docs/doc/*/*.html; do
            sed -i -E "s|(href=\")https://w3id.org/EDAAnOWL(/([0-9]+\.[0-9]+\.[0-9]+))?/vocabularies/([A-Za-z0-9._-]+)\"|\\1https://w3id.org/EDAAnOWL/${V}/vocabularies/\\4\"|g" "$f"
          done

      - name: Prepare files for deployment
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          DEST_VERSION=${{ steps.get_version.outputs.VERSION_NO_V }}

          echo "Preparing files for deploy folder $DEST_VERSION"
          mkdir -p deploy/$DEST_VERSION

          echo "Copying Widoco documentation files..."
          cp -r build/docs/doc/* deploy/$DEST_VERSION/

          echo "Copying RDF serialization files (ontology.*)..."
          find build/docs -maxdepth 1 -type f -exec cp -t deploy/$DEST_VERSION/ {} +

          echo "Copying source EDAAnOWL.ttl..."
          if [ -f "src/$DEST_VERSION/EDAAnOWL.ttl" ]; then
            cp -f "src/$DEST_VERSION/EDAAnOWL.ttl" "deploy/$DEST_VERSION/EDAAnOWL.ttl"
          fi

          echo "Copying vocabularies..."
          mkdir -p deploy/$DEST_VERSION/vocabularies
          if [ -n "$(ls src/$DEST_VERSION/vocabularies/*.ttl 2>/dev/null)" ]; then
            cp src/$DEST_VERSION/vocabularies/*.ttl deploy/$DEST_VERSION/vocabularies/
          fi

          echo "Copying shapes..."
          mkdir -p deploy/$DEST_VERSION/shapes
          if [ -n "$(ls src/$DEST_VERSION/shapes/*.ttl 2>/dev/null)" ]; then
            cp src/$DEST_VERSION/shapes/*.ttl deploy/$DEST_VERSION/shapes/
          fi

          echo "Copying examples..."
          mkdir -p deploy/$DEST_VERSION/examples
          if [ -n "$(ls src/$DEST_VERSION/examples/*.ttl 2>/dev/null)" ]; then
            cp src/$DEST_VERSION/examples/*.ttl deploy/$DEST_VERSION/examples/
          fi

          echo "Copying versioned README.md..."
          if [ -f "src/$DEST_VERSION/README.md" ]; then
            cp "src/$DEST_VERSION/README.md" "deploy/$DEST_VERSION/README.md"
          fi

          echo "Copying versioned index.html..."
          if [ -f "src/$DEST_VERSION/index.html" ]; then
            cp "src/$DEST_VERSION/index.html" "deploy/$DEST_VERSION/index.html"
          fi

          echo "Copying root index.html..."
          if [ -f "src/index.html" ]; then
            cp "src/index.html" "deploy/index.html"
          else
            echo "--- WARN: src/index.html not found. Landing page will be missing. ---"
          fi

          echo "Copying assets (CSS and JS)..."
          if [ -d "src/assets" ]; then
            cp -r "src/assets" "deploy/assets"
            echo "Assets copied successfully"
          else
            echo "--- WARN: src/assets not found. Styles and scripts will be missing. ---"
          fi

          echo "Syncing 'latest'..."
          rm -rf deploy/latest
          cp -r deploy/$DEST_VERSION deploy/latest

          echo "Disabling Jekyll..."
          touch deploy/.nojekyll

          echo "DEPLOY_ROOT=deploy" >> $GITHUB_OUTPUT

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ steps.prep.outputs.DEPLOY_ROOT }}
          publish_branch: gh-pages
          keep_files: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "Deploy: Deploy ${{ steps.get_version.outputs.VERSION_TAG_V }} to gh-pages"
